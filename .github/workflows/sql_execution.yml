name: DB Migrations

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  migrate:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      
      - name: Install MySQL Client
        run: |
          sudo apt update
          sudo apt install -y mysql-client
      
      - name: Run SQL scripts
        env:
          DB_NAME: ${{ secrets.DB_NAME }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_HOST: ${{ secrets.DB_HOST }}
        run: |
          echo "Running SQL scripts..."
          for sql_file in sql/*.sql; do
            if [ -f "$sql_file" ]; then
              echo "Executing: $sql_file"
              mysql --host=$DB_HOST --user=$DB_USER --password=$DB_PASSWORD $DB_NAME < $sql_file || echo "Warning: Failed to execute $sql_file"
            fi
          done
          echo "All SQL scripts executed!"
